name: Build and Upload Windows FIM Daemon

on:
  push:
    branches:
      - main

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Python
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt
        shell: pwsh

      # Create dist folder
      - name: Create dist folder
        run: New-Item -ItemType Directory -Path src\dist -Force
        shell: pwsh

      # Build the EXE installer
      - name: Build Windows Installer (.exe)
        run: |
          cd src
          ps2exe .\install.ps1 .\dist\fim-daemon-setup.exe -noConsole
          echo "Installer built at src\dist\fim-daemon-setup.exe"
        shell: pwsh

      # Check that the installer exists
      - name: Verify build output
        run: |
          if (!(Test-Path "src\dist\fim-daemon-setup.exe")) {
            Write-Error "Installer not found!"
            exit 1
          }
        shell: pwsh

      # Upload to EC2
      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "src/dist/fim-daemon-setup.exe"
          target: "~/fim-distribution/public/downloads"
